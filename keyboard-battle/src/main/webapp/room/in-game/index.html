<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>키보드 배틀 - 게임중</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" />
  <link rel="stylesheet" href="/styles/ingame.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script>
    let ws = null;
    let roomId = new URLSearchParams(window.location.search).get("id");
    let myNickname = "";
    let myUserId = "";
    let myPosition = null;
    let refreshInterval = null;

    let tajaStartTime = null;
    let combo = 0;
    let bomb = 2;
    let attackGauge = 0;
    let averageTajaSpeed = 0;
    let currentTajaSpeed = 0;
    let averageAccuracy = 0;
    let currentAccuracy = 0;
    let completeCount = 0;
    let typingTextQueue = [];
    let player0Score = 0;
    let player1Score = 0;
    let player0GameOver = false;
    let player1GameOver = false;


    const duration = 2000;
    const frameRate = 60;

    function countKeystrokesSentence(sentence) {
      const sentenceString = sentence ? sentence : "";
      let totalKeyStrokes = 0;
      for (let i = 0; i < sentenceString.length; i++) {
        totalKeyStrokes += countKeystrokes(sentenceString[i]);
      }
      return totalKeyStrokes;
    }

    function countKeystrokes(hangulChar) {
      const CHO = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
      const JUNG = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'];
      const JONG = ['', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];

      const BASE_CODE = 0xAC00; // '가'의 유니코드
      const charCode = hangulChar.charCodeAt(0);

      if (charCode < BASE_CODE || charCode > BASE_CODE + 11171) {
        return 1; // 한글 범위가 아닐 경우
      }

      // 초성, 중성, 종성 인덱스 계산
      let index = charCode - BASE_CODE;
      let jong = index % 28;
      let jung = ((index - jong) / 28) % 21;
      let cho = ((index - jong) / 28 - jung) / 21;

      // 기본 타이핑 횟수는 초성 + 중성 (2타)
      let keystrokes = 2;

      // 종성이 존재하면 추가 1타
      if (jong > 0) {
        keystrokes += 1;

        // 겹받침이면 추가 1타
        if (['ㄳ', 'ㄵ', 'ㄶ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅄ'].includes(JONG[jong])) {
          keystrokes += 1;
        }
      }

      return keystrokes;
    }

    function updateScore(position, addScore) {
      let currentNumber = position === 0 ? player0Score : player1Score;
      let targetNumber = currentNumber + addScore;
      let step = (targetNumber - currentNumber) / (duration / (1000 / frameRate));
      let interval = setInterval(function () {
        currentNumber += step;
        if (currentNumber >= targetNumber) {
          currentNumber = targetNumber;
          clearInterval(interval);
        }
        $(`#player${position}-score`).text(Math.round(currentNumber));
      }, 1000 / frameRate);
      if (position === 0) {
        player0Score = Math.round(targetNumber);
      } else {
        player1Score = Math.round(targetNumber);
      }
    }

    function updateScoreWithTotalScore(position, addScore) {
      let currentNumber = position === 0 ? player0Score : player1Score;
      let targetNumber = currentNumber + addScore;
      let step = (targetNumber - currentNumber) / (duration / (1000 / frameRate));
      let interval = setInterval(function () {
        currentNumber += step;
        if (currentNumber >= targetNumber) {
          currentNumber = targetNumber;
          clearInterval(interval);
        }
        $(`#player${position}-score`).text(Math.round(currentNumber));
        $(`#player${position}-result-score`).text(Math.round(currentNumber));
      }, 1000 / frameRate);
      if (position === 0) {
        player0Score = Math.round(targetNumber);
      } else {
        player1Score = Math.round(targetNumber);
      }
    }

    function addText(position, text) {
      const container = $(`#player${position}-typing-text-container`);
      const newText = $("<p>").addClass("typing-text").text(text);

      container.prepend(newText);
      if (parseInt(position) === parseInt(myPosition)) {
        typingTextQueue.push(text);
      }

      if (typingTextQueue.length > 12) {
        if (myPosition === null) {
          return;
        }
        if (myPosition === 0) {
          if (player0GameOver) {
            return;
          }
          $('#player0-typing-input').prop('disabled', true);
          $('#player0-typing-input').val('게임 오버');
          player0GameOver = true;
          ws.send(`gameover::${position}`);
        }
        if (myPosition === 1) {
          if (player1GameOver) {
            return;
          }
          $('#player1-typing-input').prop('disabled', true);
          $('#player1-typing-input').val('게임 오버');
          player1GameOver = true;
          ws.send(`gameover::${position}`);
        }
      }
    }

    function removeText(position) {
      const container = $(`#player${position}-typing-text-container`);
      const texts = container.find(".typing-text");

      if (texts.length > 0) {
        const lastText = $(texts[texts.length - 1]);
        lastText.css("animation", "fadeOut 0.2s ease-out forwards");

        setTimeout(() => {
          lastText.remove();
          if (parseInt(position) === parseInt(myPosition)) {
            typingTextQueue.shift();
          }
        }, 200);
      }
    }

    function remove5Text(position) {
      const container = document.getElementById(`player${position}-typing-text-container`);
      const texts = container.getElementsByClassName("typing-text");

      for (let index = 0; index < 5; index++) {
        if (texts.length > 0) {
          setTimeout(() => {
            const lastText = texts[texts.length - 1];
            lastText.remove();
            if (parseInt(position) === parseInt(myPosition)) {
              typingTextQueue.shift();
            }
            console.log(typingTextQueue);
          }, 100 * index);
        }
      }
    }

    function receivePositionMessage(message) {
      const position = Number(message.split("::")[1]);
      myPosition = position;
      if (position === 1) {
        $('#player1-typing-input').prop('disabled', false);
        $('#player0-combo').text('?');
        $('#player0-bomb').text('?');
        $('#player0-attack-gauge-text').text('?');
        $('#player0-attack-gauge-bar').css('width', '0%');
      } else {
        $('#player0-typing-input').prop('disabled', false);
        $('#player1-combo').text('?');
        $('#player1-bomb').text('?');
        $('#player1-attack-gauge-text').text('?');
        $('#player1-attack-gauge-bar').css('width', '0%');
      }

      $(`#player${position}-typing-input`).on('input', function () {
        if (typingTextQueue.length === 0) {
          $(`#player${position}-typing-input`).val('');
          return;
        }
        if (!tajaStartTime) {
          tajaStartTime = new Date();
        }

        const input = $(`#player${position}-typing-input`).val();
        const sanitizedInput = input.replace(/::/g, '');
        if (sanitizedInput.length > 1) {
          ws.send(`taja::${position}::${sanitizedInput}::${currentTajaSpeed}::${currentAccuracy}`);
        }

        if (countKeystrokesSentence(input) > countKeystrokesSentence(typingTextQueue[0])) {
          if (currentTajaSpeed > 0 && input.length > 1) {
            removeText(position);
            $(`#player${position}-typing-log`).text(input);
            $(`#player${position}-typing-input`).val('');
            tajaStartTime = null;

            if (currentAccuracy === 100) {
              combo++;
            } else {
              combo = 0;
            }
            let addScore = Math.round(currentTajaSpeed * currentAccuracy * currentAccuracy * (combo + 1) / 500);
            updateScore(position, addScore);

            averageTajaSpeed = Math.round((averageTajaSpeed * completeCount + currentTajaSpeed) / (completeCount + 1));
            averageAccuracy = Math.round((averageAccuracy * completeCount + currentAccuracy) / (completeCount + 1));
            completeCount++;
            let addAttackGauge = averageTajaSpeed * (combo + 1) * 0.005;
            attackGauge += addAttackGauge;
            let attackGaugeShow = attackGauge.toFixed(2);
            if (attackGauge > 100.0) {
              attackGauge = 100.0;
              attackGaugeShow = 'MAX';
            }
            $(`#player${position}-average-typing-speed`).text(`${averageTajaSpeed}타`);
            $(`#player${position}-average-accuracy`).text(`${averageAccuracy}%`);
            $(`#player${position}-combo`).text(combo);
            $(`#player${position}-attack-gauge-text`).text(attackGaugeShow);
            $(`#player${position}-attack-gauge-bar`).css('width', `${attackGauge}%`);
            ws.send(`complete::${position}::${averageTajaSpeed}::${averageAccuracy}::${addScore}::${combo}::${addAttackGauge}`);
          }
        }
      });

      $(`#player${position}-typing-input`).on('keypress', function (e) {
        const input = $(`#player${position}-typing-input`).val();

        if (input.trim() === "/폭탄" && e.key === "Enter") {
          if (bomb < 1) {
            return;
          }
          bomb--;
          let bombHtml = '';
          for (let i = 0; i < bomb; i++) {
            bombHtml += '<i class="bi bi-star-fill" style="color: rgb(186, 214, 58);"></i>';
          }

          let addScore = 0;
          if (typingTextQueue.length >= 5) {
            addScore = 10000; // 5 * 2000
          } else {
            addScore = typingTextQueue.length * 2000;
          }
          updateScore(position, addScore);

          $(`#player${position}-typing-input`).val('');
          tajaStartTime = null;

          $(`#player${position}-bomb`).html(bombHtml);
          remove5Text(position);
          ws.send(`bomb::${position}::${addScore}`);
          return;
        }

        if (input.trim() === "/공격" && e.key === "Enter") {
          const target = position === 0 ? 1 : 0;
          let attackCount = Math.floor(attackGauge / 10);
          if (attackCount < 1) {
            return;
          }

          attackGauge -= attackCount * 10;
          let attackGaugeShow = attackGauge.toFixed(2);

          $(`#player${position}-typing-input`).val('');
          tajaStartTime = null;

          $(`#player${position}-attack-gauge-text`).text(attackGaugeShow);
          $(`#player${position}-attack-gauge-bar`).css('width', `${attackGauge}%`);
          ws.send(`attack::${target}::${attackCount}::${position}::${attackGaugeShow}`);
          return;
        }

        if (e.key === "Enter" && countKeystrokesSentence(input) === countKeystrokesSentence(typingTextQueue[0])) {
          if (currentTajaSpeed > 0 && input.length > 1) {
            removeText(position);
            $(`#player${position}-typing-log`).text(input);
            $(`#player${position}-typing-input`).val('');
            tajaStartTime = null;

            if (currentAccuracy === 100) {
              combo++;
            } else {
              combo = 0;
            }
            let addScore = Math.round(currentTajaSpeed * currentAccuracy * currentAccuracy * (combo + 1) / 500);
            updateScore(position, addScore);

            averageTajaSpeed = Math.round((averageTajaSpeed * completeCount + currentTajaSpeed) / (completeCount + 1));
            averageAccuracy = Math.round((averageAccuracy * completeCount + currentAccuracy) / (completeCount + 1));
            completeCount++;
            let addAttackGauge = averageTajaSpeed * (combo + 1) * 0.005;
            attackGauge += addAttackGauge;
            let attackGaugeShow = attackGauge.toFixed(2);
            if (attackGauge > 100.0) {
              attackGauge = 100.0;
              attackGaugeShow = 'MAX';
            }
            $(`#player${position}-average-typing-speed`).text(`${averageTajaSpeed}타`);
            $(`#player${position}-average-accuracy`).text(`${averageAccuracy}%`);
            $(`#player${position}-combo`).text(combo);
            $(`#player${position}-attack-gauge-text`).text(attackGaugeShow);
            $(`#player${position}-attack-gauge-bar`).css('width', `${attackGauge}%`);
            ws.send(`complete::${position}::${averageTajaSpeed}::${averageAccuracy}::${addScore}::${combo}::${addAttackGauge}`);
          }
        }
      });

      setInterval(function () {
        const inputText = $(`#player${position}-typing-input`).val();
        let currentTypingText = typingTextQueue[0] ? typingTextQueue[0] : "";
        let keyStroke = 0;
        let accuracyCount = 0;

        for (let i = 0; i < inputText.length; i++) {
          if (inputText[i] === currentTypingText[i]) {
            keyStroke += countKeystrokes(inputText[i]);
            accuracyCount++;
          }
        }

        let accuracy = (accuracyCount / currentTypingText.length) * 100;
        let elapsedTime = (new Date() - tajaStartTime) / 1000; // in seconds
        let speed = (keyStroke / elapsedTime) * 60; // characters per minute

        let showSpeed = Math.round(speed) ? Math.round(speed) : 0;
        let showAccuracy = accuracy ? Math.round(accuracy) : 0;
        $(`#player${position}-current-typing-speed`).text(showSpeed + "타");
        $(`#player${position}-current-accuracy`).text(showAccuracy + "%");
        currentTajaSpeed = showSpeed;
        currentAccuracy = showAccuracy;
      }, 20);
    }

    function receivePlaceMessage(message) {
      const spaceIndex = Number(message.split("::")[1]);
      const userNickname = message.split("::")[2];
      const userLevel = message.split("::")[3];
      const userThumbnail = message.split("::")[4];
      const userTitle = message.split("::")[5];

      $(`#player${spaceIndex}-image`).attr('src', userThumbnail);
      $(`#player${spaceIndex}-level`).text(userLevel);
      $(`#player${spaceIndex}-nickname`).text(userNickname);
      $(`#player${spaceIndex}-title`).text(userTitle);
      if (spaceIndex < 2) {
        if (myPosition !== null) {
          if (parseInt(spaceIndex) === parseInt(myPosition)) {
            $(`#player${spaceIndex}-screen`).text('(나)');
          } else {
            $(`#player${spaceIndex}-screen`).text('(상대)');
          }
        } else {
          $(`#player${spaceIndex}-screen`).text(userNickname);
        }
      } else {
        $("#spectator-list").empty();
        const spectatorList = $("#spectator-list");
        const newSpectator = $("<p>").addClass("spectator").text(`${userNickname}(${userTitle})`);
        spectatorList.append(newSpectator);
      }

      $('#loading-text').text('다른 유저 기다리는 중...');
      $('#progress-bar-value').css('width', '67%');
      $('#progress-percentage').text('67%');
    }

    function receiveStartMessage(message) {
      $('#loading-text').text('로딩 완료!');
      $('#progress-bar-value').css('width', '100%');
      $('#progress-percentage').text('100%');
      clearTimeout(refreshInterval);
      setTimeout(() => {
        $('.container').css('filter', '');
        $('.loading-container').hide();
      }, 500);
    }

    function recieveCountdownMessage(message) {
      const countdown = message.split("::")[1];
      $('.countdown-screen').text(countdown);
      if (countdown === "0") {
        $('.countdown-screen').text('START!');
        $(`#player${myPosition}-typing-input`).focus();
        setTimeout(() => {
          $('.countdown-screen').hide();
        }, 1000);
      }
    }

    function receiveTimeMessage(message) {
      const time = message.split("::")[1];
      if (time > 300) {
        return;
      }
      if (player0GameOver && player1GameOver) {
        return;
      }
      const timeText = `${Math.floor(time / 60)}:${time % 60 < 10 ? "0" + time % 60 : time % 60}`;
      $('.game-remain-time-text').text(timeText);
      $('.countdown-screen').hide();
    }

    function receiveChatMessage(message) {
      const user = message.split("::")[1];
      const clientType = message.split("::")[2];
      const chatInput = message.split("::")[3];
      const chatBody = $("#chat-box-body");
      chatBody.append(`
        <div class="message-box">
          <span class="chat-user">${user}[${clientType}]</span>
          <span class="chat-message">${chatInput}</span>
        </div>
      `);
      chatBody.scrollTop(chatBody[0].scrollHeight);
    }

    function receiveLevelMessage(message) {
      const level = message.split("::")[1];
      if (!player0GameOver) {
        $('#player0-game-level').text(`Level ${level}`);
      }
      if (!player1GameOver) {
        $('#player1-game-level').text(`Level ${level}`);
      }
      if (myPosition === null) {
        $('#player0-game-level').text(`Level ${level}`);
        $('#player1-game-level').text(`Level ${level}`);
      }
      if (myPosition !== null) {
        if (Number(myPosition) === 0 && !player0GameOver) {
          ws.send(`level::${myPosition}::${level}`);
        }
        if (Number(myPosition) === 1 && !player1GameOver) {
          ws.send(`level::${myPosition}::${level}`);
        }
      }
    }

    function receiveTextMessage(message) {
      const text = message.split("::")[1];
      addText(0, text);
      addText(1, text);
    }

    function receiveTajaMessage(message) {
      const position = message.split("::")[1];
      const playerText = message.split("::")[2];
      const playerSpeed = message.split("::")[3];
      const playerAccuracy = message.split("::")[4];

      $(`#player${position}-typing-input`).val(playerText);
      $(`#player${position}-current-typing-speed`).text(`${playerSpeed}타`);
      $(`#player${position}-current-accuracy`).text(`${playerAccuracy}%`);
    }

    function receiveCompleteMessage(message) {
      const position = Number(message.split("::")[1]);
      const playerAverageSpeed = message.split("::")[2];
      const playerAverageAccuracy = message.split("::")[3];
      const playerAddScore = Number(message.split("::")[4]);
      const playerCombo = Number(message.split("::")[5]);
      const playerAddAttackGauge = Number(message.split("::")[6]);

      removeText(position);
      $(`#player${position}-typing-input`).val('');

      let currentNumber = position === 0 ? player0Score : player1Score;
      let targetNumber = currentNumber + playerAddScore;
      let step = (targetNumber - currentNumber) / (duration / (1000 / frameRate));
      let interval = setInterval(function () {
        currentNumber += step;
        if (currentNumber >= targetNumber) {
          currentNumber = targetNumber;
          clearInterval(interval);
        }
        $(`#player${position}-score`).text(Math.round(currentNumber));
      }, 1000 / frameRate);
      if (position === 0) {
        player0Score = Math.round(targetNumber);
      } else {
        player1Score = Math.round(targetNumber);
      }
      $(`#player${position}-average-typing-speed`).text(`${playerAverageSpeed}타`);
      $(`#player${position}-average-accuracy`).text(`${playerAverageAccuracy}%`);
      if (myPosition === null) {
        $(`#player${position}-combo`).text(playerCombo);
        $(`#player${position}-attack-gauge-text`).text(playerAddAttackGauge.toFixed(2));
        $(`#player${position}-attack-gauge-bar`).css('width', `${playerAddAttackGauge}%`);
      }
    }

    function receiveBombMessage(message) {
      const position = Number(message.split("::")[1]);
      const bombCount = Number(message.split("::")[2]);
      const addScore = Number(message.split("::")[3]);
      const attackGauge = Number(message.split("::")[4]);

      if (myPosition === null) {
        let bombHtml = '';
        for (let i = 0; i < bombCount; i++) {
          bombHtml += '<i class="bi bi-star-fill" style="color: rgb(186, 214, 58);"></i>';
        }
        $(`#player${position}-bomb`).html(bombHtml);
        return;
      }

      updateScore(position, addScore);
      remove5Text(position);
    }

    function receiveAddBombMessage(message) {
      if (myPosition === null) {
        return;
      }
      ws.send(`addbomb::${myPosition}`);
    }

    function receiveCheckBombMessage(message) {
      const position = Number(message.split("::")[1]);
      const bombCount = Number(message.split("::")[2]);
      if (myPosition === null) {
        let bombHtml = '';
        for (let i = 0; i < bombCount; i++) {
          bombHtml += '<i class="bi bi-star-fill" style="color: rgb(186, 214, 58);"></i>';
        }
        $(`#player${position}-bomb`).html(bombHtml);
        return;
      }
      if (parseInt(position) == parseInt(myPosition)) {
        bomb = bombCount;
        let bombHtml = '';
        for (let i = 0; i < bombCount; i++) {
          bombHtml += '<i class="bi bi-star-fill" style="color: rgb(186, 214, 58);"></i>';
        }
        $(`#player${position}-bomb`).html(bombHtml);
        return;
      }
    }

    function receiveAttackMessage(message) {
      const target = Number(message.split("::")[1]);
      const attackCount = Number(message.split("::")[2]);
      const position = Number(message.split("::")[3]);
      const attackGauge = Number(message.split("::")[4]);

      for (let i = 0; i < attackCount; i++) {
        setTimeout(() => {
          const text = message.split("::")[5 + i];
          addText(target, text);
        }, 100 * i);
      }

      $(`#player${position}-attack-gauge-text`).text(attackGauge.toFixed(2));
      $(`#player${position}-attack-gauge-bar`).css('width', `${attackGauge}%`);
    }

    function receiveGameendMessage(message) {
      if (myPosition !== null) {
        ws.send(`gameover::${myPosition}`);
      }
    }

    function receiveGameoverMessage(message) {
      const position = Number(message.split("::")[1]);
      if (position === 0) {
        $('#player0-typing-input').prop('disabled', true);
        $('#player0-typing-input').val('게임 오버');
        player0GameOver = true;
      }
      if (position === 1) {
        $('#player1-typing-input').prop('disabled', true);
        $('#player1-typing-input').val('게임 오버');
        player1GameOver = true;
      }
    }

    function receiveResultMessage(message) {
      const winner = Number(message.split("::")[1]);
      const reachedLevel0 = Number(message.split("::")[2]);
      const totalScore0 = Number(message.split("::")[3]);
      const averageSpeed0 = Number(message.split("::")[4]);
      const averageAccuracy0 = Number(message.split("::")[5]);
      const maxCombo0 = Number(message.split("::")[6]);
      const bomb0 = Number(message.split("::")[7]);
      const gainedExp0 = Number(message.split("::")[8]);

      const reachedLevel1 = Number(message.split("::")[9]);
      const totalScore1 = Number(message.split("::")[10]);
      const averageSpeed1 = Number(message.split("::")[11]);
      const averageAccuracy1 = Number(message.split("::")[12]);
      const maxCombo1 = Number(message.split("::")[13]);
      const bomb1 = Number(message.split("::")[14]);
      const gainedExp1 = Number(message.split("::")[15]);

      $('#player0-result-level').text(reachedLevel0);
      $('#player0-result-speed').text(averageSpeed0);
      $('#player0-result-accuracy').text(averageAccuracy0);
      $('#player0-result-combo').text(maxCombo0);
      $('#player0-result-bomb').text(bomb0);
      $('#player0-result-score').text(player0Score);
      $('#player0-result-exp').text(gainedExp0);

      $('#player1-result-level').text(reachedLevel1);
      $('#player1-result-speed').text(averageSpeed1);
      $('#player1-result-accuracy').text(averageAccuracy1);
      $('#player1-result-combo').text(maxCombo1);
      $('#player1-result-bomb').text(bomb1);
      $('#player1-result-score').text(player1Score);
      $('#player1-result-exp').text(gainedExp1);

      $('.result-screen').show();

      setTimeout(() => {
        updateScoreWithTotalScore(0, Number(totalScore0 - player0Score));
        updateScoreWithTotalScore(1, Number(totalScore1 - player1Score));
      }, 1000);

      setTimeout(() => {
        if (winner === 0) {
          $('#player0-win').text('승!');
          $('#player1-win').text('패');
        } else {
          $('#player0-win').text('패');
          $('#player1-win').text('승!');
        }
        $('#player0-win').css('opacity', '1');
        $('#player1-win').css('opacity', '1');

        const chatBody = $("#chat-box-body");
        chatBody.append('<div class="message-box"><span class="chat-user">시스템</span><span class="chat-message">10초 후 대기실로 이동합니다.</span></div>');
        chatBody.scrollTop(chatBody[0].scrollHeight);
      }, 2000);

      setTimeout(() => {
        window.location.href = "/room?id=" + roomId;
      }, 12000);
    }

    $(document).ready(function () {
      if (roomId === undefined || roomId === null || roomId === "") {
        window.location.href = "/free-channel";
      }

      setInterval(() => {
        $('.player-screen').css('user-select', 'none');
      }, 1000);

      ws = new WebSocket("/in-game/" + roomId);
      ws.onopen = function () {
        myNickname = document.cookie.split('; ').find(row => row.startsWith('nickname=')).split('=')[1];
        myUserId = document.cookie.split('; ').find(row => row.startsWith('userid=')).split('=')[1];

        ws.send("check::" + myUserId);
        $('.container').css('filter', 'blur(5px)');
        $('#loading-text').text('유저 정보 확인중...');
        $('#progress-bar-value').css('width', '33%');
        $('#progress-percentage').text('33%');

        setTimeout(() => {
          $('#loading-text').text('로딩이 너무 오래 걸리면, 새로고침을 시도해주세요. 10초 후 새로고침됩니다.');
        }, 10000);
        refreshInterval = setTimeout(() => {
          window.location.reload();
        }, 20000);
      };

      ws.onmessage = function (event) {
        const msgType = event.data.split("::")[0];
        switch (msgType) {
          case "position":
            receivePositionMessage(event.data);
            break;
          case "place":
            receivePlaceMessage(event.data);
            break;
          case "start":
            receiveStartMessage(event.data);
            break;
          case "countdown":
            recieveCountdownMessage(event.data);
            break;
          case "time":
            receiveTimeMessage(event.data);
            break;
          case "chat":
            receiveChatMessage(event.data);
            break;
          case "level":
            receiveLevelMessage(event.data);
            break;
          case "text":
            receiveTextMessage(event.data);
            break;
          case "taja":
            receiveTajaMessage(event.data);
            break;
          case "complete":
            receiveCompleteMessage(event.data);
            break;
          case "bomb":
            receiveBombMessage(event.data);
            break;
          case "addbomb":
            receiveAddBombMessage(event.data);
            break;
          case "checkbomb":
            receiveCheckBombMessage(event.data);
            break;
          case "attack":
            receiveAttackMessage(event.data);
            break;
          case "gameend":
            receiveGameendMessage(event.data);
            break;
          case "gameover":
            receiveGameoverMessage(event.data);
            break;
          case "result":
            receiveResultMessage(event.data);
            break;
          case "end":
            window.location.href = "/free-channel";
            break;
          default:
            console.error("unknown message type");
            break;
        }
      };

      ws.onclose = function () {
        window.location.reload();
      };
      ws.onerror = function () {
        // console.log('error');
      };

      function sendChatMessage() {
        const chatInput = $('#chat-input').val().trim();
        if (chatInput === '' || chatInput === null) {
          return;
        }
        const clientType = myPosition !== null ? '플레이어' : '관전자';
        const chatMessage = `chat::${myNickname}[${clientType}]::${chatInput}`;
        const chatMessageWs = `chat::${myNickname}::${clientType}::${chatInput}`;
        const chatBody = $("#chat-box-body");
        chatBody.append(`<div class="message-box"><span class="chat-user">${myNickname}[${clientType}]</span><span class="chat-message">${chatInput}</span></div>`);
        chatBody.scrollTop(chatBody[0].scrollHeight);
        $("#chat-input").val("");
        ws.send(chatMessageWs);
      }

      $("#chat-input").on("keypress", function (e) {
        if (e.key === "Enter") {
          sendChatMessage();
        }
      });
    });
  </script>
</head>

<body>
  <div class="container">
    <div class="player-screen">
      <div class="player-show">
        <figure class="player-figure">
          <img id="player0-image" class="player-image" src="/images/white-image.png" alt="" />
        </figure>
        <div class="player-box">
          <span id="player0-level" class="badge text-bg-primary player-level"></span>
          <span id="player0-nickname" class="player-nickname"></span>
          <p id="player0-screen"></p>
          <span id="player0-title" class="badge text-bg-warning player-title"></span>
        </div>
      </div>
      <div class="game-main">
        <div class="countdown-screen"></div>
        <div id="player0-result" class="result-screen" style="display: flex;">
          <p id="player0-win" style="font-size: 2rem; margin-bottom: 20px; opacity: 0;">.</p>
          <div class="result-screen-text" style="opacity: 1;">
            <p>레벨 도달</p>
            <p id="player0-result-level" style="display: flex;"></p>
          </div>
          <div class="result-screen-text">
            <p>평균 타자속도</p>
            <p style="display: flex;">
              <span id="player0-result-speed"></span>
              <span>타</span>
            </p>
          </div>
          <div class="result-screen-text">
            <p>평균 정확도</p>
            <p style="display: flex;">
              <span id="player0-result-accuracy"></span>
              <span>%</span>
            </p>
          </div>
          <div class="result-screen-text">
            <p>최대 Combo</p>
            <p id="player0-result-combo">1</p>
          </div>
          <div class="result-screen-text">
            <p>남은 Bomb 수</p>
            <p id="player0-result-bomb"></p>
          </div>
          <div class="result-screen-text" style="margin-top: 20px; font-size: 1.2rem;">
            <p>보너스 점수: (도달 레벨 × 정확도²) + (최대 콤보 × 평균 타자속도 × 10) + (남은 폭탄 수 × 25000)</p>
          </div>
          <div class="result-screen-text">
            <p>점수</p>
            <p style="display: flex;">
              <span id="player0-result-score">0</span>
              <span>점</span>
            </p>
          </div>
          <div class="result-screen-text" style="margin-top: 5px;">
            <p>획득 경험치</p>
            <p style="display: flex;">
              <span>+</span>
              <span id="player0-result-exp">0</span>
              <span>xp</span>
            </p>
          </div>
        </div>
        <div id="player0-typing-text-container" class="typing-text-container"></div>
        <div class="typing-box">
          <input id="player0-typing-input" class="typing-input" type="text" autocomplete="off" disabled />
        </div>
        <div class="typing-log">
          <p id="player0-typing-log" class="typing-log-text"></p>
        </div>
      </div>
      <div class="game-sub">
        <div style="position: absolute;">
          <p id="player0-game-level" class="game-level" style="text-align: center; width: 220px; font-size: 1.5rem;">
            Level 1</p>
        </div>
        <div class="game-info">
          <div class="game-info-bottom">
            <p class="game-combo-box">
              <span>Combo</span>
              <span id="player0-combo" class="player-combo">0</span>
            </p>
            <p class="game-bomb-box">
              <span>Bomb</span>
              <span id="player0-bomb" class="player-game-bomb">
                <i class="bi bi-star-fill" style="color: rgb(186, 214, 58);"></i>
                <i class="bi bi-star-fill" style="color: rgb(186, 214, 58);"></i>
              </span>
            </p>
            <p class="game-attack-gauge-box">
              <span>공격 게이지</span>
              <span id="player0-game-attack-gauge" class="player-game-attack-gauge">
                <span id="player0-attack-gauge-bar" class="attack-gauge-bar"></span>
                <span id="player0-attack-gauge-text" class="attack-gauge-text">0</span>
              </span>
            </p>
          </div>
          <div class="game-info-top">
            <div class="game-score-box">
              <span>점수</span>
              <span id="player0-score" class="player-score">0</span>
            </div>
            <p class="game-average-typing-speed-box">
              <span>평균 타자속도</span>
              <span id="player0-average-typing-speed" class="player-average-typing-speed">0타</span>
            </p>
            <p class="game-average-accuracy-box">
              <span>평균 정확도</span>
              <span id="player0-average-accuracy" class="player-average-accuracy">0%</span>
            </p>
            <br>
            <p class="game-current-typing-speed-box">
              <span>현재 타자속도</span>
              <span id="player0-current-typing-speed" class="player-current-typing-speed">0타</span>
            </p>
            <p class="game-current-accuracy-box">
              <span>현재 정확도</span>
              <span id="player0-current-accuracy" class="player-current-accuracy">0%</span>
            </p>
          </div>
        </div>
        <div class="game-remain-time-box">
          <p>남은 시간</p>
          <div class="game-remain-time">
            <p class="game-remain-time-text">00:00</p>
          </div>
        </div>
      </div>
    </div>
    <div class="player-screen">
      <div class="player-show">
        <div class="player-show">
          <figure class="player-figure">
            <img id="player1-image" class="player-image" src="/images/white-image.png" alt="" />
          </figure>
          <div class="player-box">
            <span id="player1-level" class="badge text-bg-primary player-level"></span>
            <span id="player1-nickname" class="player-nickname"></span>
            <p id="player1-screen"></p>
            <span id="player1-title" class="badge text-bg-warning player-title"></span>
          </div>
        </div>
      </div>
      <div class="game-main">
        <div class="countdown-screen"></div>
        <div id="player1-result" class="result-screen" style="display: none;">
          <div class="result-screen-text">
            <p id="player1-win" style="font-size: 2rem; margin-bottom: 20px; opacity: 0;">.</p>
            <p>레벨 도달</p>
            <p id="player1-result-level" style="display: flex;"></p>
          </div>
          <div class="result-screen-text">
            <p>평균 타자속도</p>
            <p style="display: flex;">
              <span id="player1-result-speed"></span>
              <span>타</span>
            </p>
          </div>
          <div class="result-screen-text">
            <p>평균 정확도</p>
            <p style="display: flex;">
              <span id="player1-result-accuracy"></span>
              <span>%</span>
            </p>
          </div>
          <div class="result-screen-text">
            <p>최대 Combo</p>
            <p id="player1-result-combo"></p>
          </div>
          <div class="result-screen-text">
            <p>남은 Bomb 수</p>
            <p id="player1-result-bomb"></p>
          </div>
          <div class="result-screen-text" style="margin-top: 20px; font-size: 1.2rem;">
            <p>보너스 점수: (도달 레벨 × 정확도²) + (최대 콤보 × 평균 타자속도 × 10) + (남은 폭탄 수 × 25000)</p>
          </div>
          <div class="result-screen-text">
            <p>점수</p>
            <p style="display: flex;">
              <span id="player1-result-score">0</span>
              <span>점</span>
            </p>
          </div>
          <div class="result-screen-text" style="margin-top: 5px;">
            <p>획득 경험치</p>
            <p style="display: flex;">
              <span>+</span>
              <span id="player1-result-exp">0</span>
              <span>xp</span>
            </p>
          </div>
        </div>

        <div id="player1-typing-text-container" class="typing-text-container"></div>
        <div class="typing-box">
          <input id="player1-typing-input" class="typing-input" type="text" autocomplete="off" disabled />
        </div>
        <div class="typing-log">
          <p id="player1-typing-log" class="typing-log-text"></p>
        </div>
      </div>
      <div class="game-sub">
        <div style="position: absolute;">
          <p id="player1-game-level" class="game-level" style="text-align: center; width: 220px; font-size: 1.5rem;">
            Level 1</p>
        </div>
        <div class="game-info">
          <div class="game-info-bottom">
            <p class="game-combo-box">
              <span>Combo</span>
              <span id="player1-combo" class="player-combo">0</span>
            </p>
            <p class="game-bomb-box">
              <span>Bomb</span>
              <span id="player1-bomb" class="player-game-bomb">
                <i class="bi bi-star-fill" style="color: rgb(186, 214, 58);"></i>
                <i class="bi bi-star-fill" style="color: rgb(186, 214, 58);"></i>
              </span>
            </p>
            <p class="game-attack-gauge-box">
              <span>공격 게이지</span>
              <span id="player1-game-attack-gauge" class="player-game-attack-gauge">
                <span id="player1-attack-gauge-bar" class="attack-gauge-bar"></span>
                <span id="player1-attack-gauge-text" class="attack-gauge-text">0</span>
              </span>
            </p>
          </div>
          <div class="game-info-top">
            <div class="game-score-box">
              <span>점수</span>
              <span id="player1-score" class="player-score">0</span>
            </div>
            <p class="game-average-typing-speed-box">
              <span>평균 타자속도</span>
              <span id="player1-average-typing-speed" class="player-average-typing-speed">0타</span>
            </p>
            <p class="game-average-accuracy-box">
              <span>평균 정확도</span>
              <span id="player1-average-accuracy" class="player-average-accuracy">0%</span>
            </p>
            <br>
            <p class="game-current-typing-speed-box">
              <span>현재 타자속도</span>
              <span id="player1-current-typing-speed" class="player-current-typing-speed">0타</span>
            </p>
            <p class="game-current-accuracy-box">
              <span>현재 정확도</span>
              <span id="player1-current-accuracy" class="player-current-accuracy">0%</span>
            </p>
          </div>
        </div>
        <div class="game-remain-time-box">
          <p>남은 시간</p>
          <div class="game-remain-time">
            <p class="game-remain-time-text">00:00</p>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-screen">
      <div class="chat-box">
        <div id="chat-box-body" class="chat-box-body"></div>
        <input id="chat-input" class="form-control" type="text" placeholder="메시지 입력" autocomplete="off" />
      </div>
      <div class="spectators">
        <div class="spectators-container">
          <p style="font-weight: 500;" class="ms-2">관전자</p>
          <div id="spectator-list" class="spectator-list"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="loading-container">
    <div class="loading-box">
      <div class="progress loading-box" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div id="progress-percentage" class="progress-text">0%</div>
        <div id="progress-bar-value" class="progress-bar progress-bar-striped progress-bar-animated bg-info"
          style="width: 0%"></div>
      </div>
    </div>
    <p id="loading-text">연결중...</p>
  </div>
</body>

</html>