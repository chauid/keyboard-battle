<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>키보드 배틀 - 게임중</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" />
  <link rel="stylesheet" href="/styles/ingame.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script>
    let ws = null;
    let roomId = new URLSearchParams(window.location.search).get("id");
    let myNickname = "";
    let myUserId = "";
    let myPosition = null;
    let refreshInterval = null;

    let tajaStartTime = null;
    let combo = 0;
    let bomb = 2;
    let attackGauge = 0;
    let averageTajaSpeed = 0;
    let currentTajaSpeed = 0;
    let averageAccuracy = 0;
    let currentAccuracy = 0;
    let typingTextQueue = [];
    let player0Score = 0;
    let player1Score = 0;

    const duration = 3000;
    const frameRate = 60;

    function countKeystrokesSentence(sentence) {
      const sentenceString = sentence ? sentence : "";
      let totalKeyStrokes = 0;
      for (let i = 0; i < sentenceString.length; i++) {
        totalKeyStrokes += countKeystrokes(sentenceString[i]);
      }
      return totalKeyStrokes;
    }

    function countKeystrokes(hangulChar) {
      const CHO = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
      const JUNG = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'];
      const JONG = ['', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];

      const BASE_CODE = 0xAC00; // '가'의 유니코드
      const charCode = hangulChar.charCodeAt(0);

      if (charCode < BASE_CODE || charCode > BASE_CODE + 11171) {
        return 1; // 한글 범위가 아닐 경우
      }

      // 초성, 중성, 종성 인덱스 계산
      let index = charCode - BASE_CODE;
      let jong = index % 28;
      let jung = ((index - jong) / 28) % 21;
      let cho = ((index - jong) / 28 - jung) / 21;

      // 기본 타이핑 횟수는 초성 + 중성 (2타)
      let keystrokes = 2;

      // 종성이 존재하면 추가 1타
      if (jong > 0) {
        keystrokes += 1;

        // 겹받침이면 추가 1타
        if (['ㄳ', 'ㄵ', 'ㄶ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅄ'].includes(JONG[jong])) {
          keystrokes += 1;
        }
      }

      return keystrokes;
    }

    function addText(position, text) {
      const container = $(`#player${position}-typing-text-container`);
      const newText = $("<p>").addClass("typing-text").text(text);

      console.log(position, myPosition);
      container.prepend(newText);
      if (position === myPosition) {
        typingTextQueue.push(text);
      }

      if (typingTextQueue.length > 12) {
        console.log('게임 종료');
      }
      console.log(typingTextQueue);
    }

    function removeText(position) {
      const container = document.getElementById(`player${position}-typing-text-container`);
      const texts = container.getElementsByClassName("typing-text");

      if (texts.length > 0) {
        const lastText = texts[texts.length - 1];
        lastText.style.animation = "fadeOut 0.2s ease-out forwards";

        setTimeout(() => {
          lastText.remove();
          typingTextQueue.shift();
          console.log(typingTextQueue);
        }, 200);
      }
    }

    function receivePositionMessage(message) {
      const position = message.split("::")[1];
      myPosition = position;
      if (position === "1") {
        $('#player1-typing-input').prop('disabled', false);
      } else if (position === "0") {
        $('#player0-typing-input').prop('disabled', false);
      }

      $(`#player${position}-typing-input`).on('input', function () {
        if (!tajaStartTime) {
          tajaStartTime = new Date();
        }

        const input = $(`#player${position}-typing-input`).val();
        const sanitizedInput = input.replace(/::/g, '');
        if (sanitizedInput.length > 1) {
          ws.send(`taja::${position}::${sanitizedInput}::${currentTajaSpeed}::${currentAccuracy}`);
        }

        if (countKeystrokesSentence(input) > countKeystrokesSentence(typingTextQueue[0])) {
          removeText(position);
          $(`#player${position}-typing-input`).val('');
          tajaStartTime = null;

          if (currentAccuracy === 100) {
            combo++;
          } else {
            combo = 0;
          }
          let currentNumber = position === "0" ? player0Score : player1Score;
          let targetNumber = currentNumber + ((currentTajaSpeed * 1000) * (currentAccuracy / 100) * ((combo + 1) * 0.2));
          console.log("현재값:", currentNumber, "목표값:", targetNumber);
          console.log("증가값:", ((currentTajaSpeed * 1000) * (currentAccuracy / 100) * ((combo + 1) * 0.2)));
          // ===================================           평균 타자속도, 정확도        ==================================================
          let step = (targetNumber - currentNumber) / (duration / (1000 / frameRate));
          let interval = setInterval(function () {
            currentNumber += step;
            if (currentNumber >= targetNumber) {
              currentNumber = targetNumber;
              clearInterval(interval);
            }
            $(`#player${position}-score`).text(Math.floor(currentNumber));
            if (position === "0") {
              player0Score = currentNumber;
            } else {
              player1Score = currentNumber;
            }
          }, 1000 / frameRate);
          if (currentTajaSpeed > 0) {
            ws.send(`complete::${position}::${currentTajaSpeed}::${currentAccuracy}`);
          }
        }
      });

      $(`#player${position}-typing-input`).on('keypress', function (e) {
        const input = $(`#player${position}-typing-input`).val();
        if (e.key === "Enter" && countKeystrokesSentence(input) === countKeystrokesSentence(typingTextQueue[0])) {
          removeText(position);
          $(`#player${position}-typing-input`).val('');
          tajaStartTime = null;

          if (currentAccuracy === 100) {
            combo++;
          } else {
            combo = 0;
          }
          let currentNumber = position === "0" ? player0Score : player1Score;
          let targetNumber = currentNumber + ((currentTajaSpeed * 1000) * (currentAccuracy / 100) * ((combo + 1) * 0.2));
          console.log("현재값:", currentNumber, "목표값:", targetNumber);
          console.log("증가값:", ((currentTajaSpeed * 1000) * (currentAccuracy / 100) * ((combo + 1) * 0.2)));
          let step = (targetNumber - currentNumber) / (duration / (1000 / frameRate));
          let interval = setInterval(function () {
            currentNumber += step;
            if (currentNumber >= targetNumber) {
              currentNumber = targetNumber;
              clearInterval(interval);
            }
            $(`#player${position}-score`).text(Math.floor(currentNumber));
            if (position === "0") {
              player0Score = currentNumber;
            } else {
              player1Score = currentNumber;
            }
          }, 1000 / frameRate);
          if (currentTajaSpeed > 0) {
            ws.send(`complete::${position}::${currentTajaSpeed}::${currentAccuracy}`);
          }
        }
      });

      setInterval(function () {
        const inputText = $(`#player${position}-typing-input`).val();
        let currentTypingText = typingTextQueue[0] ? typingTextQueue[0] : "";
        let keyStroke = 0;
        let accuracyCount = 0;

        for (let i = 0; i < inputText.length; i++) {
          if (inputText[i] === currentTypingText[i]) {
            keyStroke += countKeystrokes(inputText[i]);
            accuracyCount++;
          }
        }

        let accuracy = (accuracyCount / currentTypingText.length) * 100;
        let elapsedTime = (new Date() - tajaStartTime) / 1000; // in seconds
        let speed = (keyStroke / elapsedTime) * 60; // characters per minute

        let showSpeed = Math.round(speed) ? Math.round(speed) : 0;
        let showAccuracy = accuracy ? Math.round(accuracy) : 0;
        $(`#player${position}-current-typing-speed`).text(showSpeed + "타");
        $(`#player${position}-current-accuracy`).text(showAccuracy + "%");
        currentTajaSpeed = showSpeed;
        currentAccuracy = showAccuracy;
      }, 50);
    }

    function receivePlaceMessage(message) {
      const spaceIndex = message.split("::")[1];
      const userNickname = message.split("::")[2];
      const userLevel = message.split("::")[3];
      const userThumbnail = message.split("::")[4];
      const userTitle = message.split("::")[5];

      if (spaceIndex < 2) {
        if (myPosition < 2) {
          if (spaceIndex === myPosition) {
            $(`#player${spaceIndex}-screen`).text(`${userNickname}(나)`);
          } else {
            $(`#player${spaceIndex}-screen`).text(`${userNickname}(상대)`);
          }
        } else {
          $(`#player${spaceIndex}-screen`).text(userNickname);
        }
      }
      const spectatorList = $("#spectator-list");
      const newSpectator = $("<p>").addClass("spectator").text(`${userNickname}(${userTitle})`);
      spectatorList.append(newSpectator);

      $('#loading-text').text('다른 유저 기다리는 중...');
      $('#progress-bar-value').css('width', '67%');
      $('#progress-percentage').text('67%');
    }

    function receiveStartMessage(message) {
      $('#loading-text').text('로딩 완료!');
      $('#progress-bar-value').css('width', '100%');
      $('#progress-percentage').text('100%');
      clearTimeout(refreshInterval);
      setTimeout(() => {
        $('.container').css('filter', '');
        $('.loading-container').hide();
      }, 500);
    }

    function recieveCountdownMessage(message) {
      const countdown = message.split("::")[1];
      $('.countdown-screen').text(countdown);
      if (countdown === "0") {
        $('.countdown-screen').text('START!');
        $(`#player${myPosition}-typing-input`).focus();
        setTimeout(() => {
          $('.countdown-screen').hide();
        }, 1000);
      }
    }

    function receiveTimeMessage(message) {
      const time = message.split("::")[1];
      if (time > 300) {
        return;
      }
      const timeText = `${Math.floor(time / 60)}:${time % 60 < 10 ? "0" + time % 60 : time % 60}`;
      $('.game-remain-time-text').text(timeText);
      $('.countdown-screen').hide();
    }

    function receiveChatMessage(message) {
      const user = message.split("::")[1];
      const clientType = message.split("::")[2];
      const chatInput = message.split("::")[3];
      const chatBody = $("#chat-box-body");
      chatBody.append(`
        <div class="message-box">
          <span class="chat-user">${user}[${clientType}]</span>
          <span class="chat-message">${chatInput}</span>
        </div>
      `);
      chatBody.scrollTop(chatBody[0].scrollHeight);
    }

    function receiveTextMessage(message) {
      const text = message.split("::")[1];
      addText('0', text);
      addText('1', text);
    }

    function receiveTajaMessage(message) {
      const position = message.split("::")[1];
      const playerText = message.split("::")[2];
      const playerSpeed = message.split("::")[3];
      const playerAccuracy = message.split("::")[4];

      $(`#player${position}-typing-input`).val(playerText);
      $(`#player${position}-current-typing-speed`).text(`${playerSpeed}타`);
      $(`#player${position}-current-accuracy`).text(`${playerAccuracy}%`);
    }

    function receiveCompleteMessage(message) {
      const position = message.split("::")[1];
      const playerAverageSpeed = message.split("::")[2];
      const playerAverageAccuracy = message.split("::")[3];
      const playerAddScore = message.split("::")[4];

      $(`#player${position}-score`).text(`${playerAverageSpeed}타`);
      $(`#player${position}-current-accuracy`).text(`${playerAverageAccuracy}%`);
    }

    function receiveRemoveMessage(message) {

    }

    function receiveResultMessage(message) {

    }

    $(document).ready(function () {
      if (roomId === undefined || roomId === null || roomId === "") {
        window.location.href = "/free-channel";
      }

      setInterval(() => {
        $('.player-screen').css('user-select', 'none');
      }, 1000);


      ws = new WebSocket("/in-game/" + roomId);
      ws.onopen = function () {
        myNickname = document.cookie.split('; ').find(row => row.startsWith('nickname=')).split('=')[1];
        myUserId = document.cookie.split('; ').find(row => row.startsWith('userid=')).split('=')[1];

        ws.send("check::" + myUserId);
        $('.container').css('filter', 'blur(5px)');
        $('#loading-text').text('유저 정보 확인중...');
        $('#progress-bar-value').css('width', '33%');
        $('#progress-percentage').text('33%');

        setTimeout(() => {
          $('#loading-text').text('로딩이 너무 오래 걸리면, 새로고침을 시도해주세요. 10초 후 새로고침됩니다.');
        }, 10000);
        refreshInterval = setTimeout(() => {
          window.location.reload();
        }, 20000);
      };

      ws.onmessage = function (event) {
        // console.log(event.data);
        const msgType = event.data.split("::")[0];
        switch (msgType) {
          case "position":
            receivePositionMessage(event.data);
            break;
          case "place":
            receivePlaceMessage(event.data);
            break;
          case "start":
            receiveStartMessage(event.data);
            break;
          case "countdown":
            recieveCountdownMessage(event.data);
            break;
          case "time":
            receiveTimeMessage(event.data);
            break;
          case "chat":
            receiveChatMessage(event.data);
            break;
          case "text":
            receiveTextMessage(event.data);
            break;
          case "taja":
            receiveTajaMessage(event.data);
            break;
          case "remove":
            receiveRemoveMessage(event.data);
            break;
          case "result":
            receiveResultMessage(event.data);
            break;
          case "end":
            window.location.href = "/free-channel";
            break;
          default:
            console.log("unknown message type");
            break;
        }
      };

      ws.onclose = function () {
        window.location.reload();
      };
      ws.onerror = function () {
        // console.log('error');
      };

      function sendChatMessage() {
        const chatInput = $('#chat-input').val().trim();
        if (chatInput === '' || chatInput === null) {
          return;
        }
        const clientType = myPosition !== null ? '플레이어' : '관전자';
        const chatMessage = `chat::${myNickname}[${clientType}]::${chatInput}`;
        const chatMessageWs = `chat::${myNickname}::${clientType}::${chatInput}`;
        const chatBody = $("#chat-box-body");
        chatBody.append(`<div class="message-box"><span class="chat-user">${myNickname}[${clientType}]</span><span class="chat-message">${chatInput}</span></div>`);
        chatBody.scrollTop(chatBody[0].scrollHeight);
        $("#chat-input").val("");
        ws.send(chatMessageWs);
      }

      $("#chat-input").on("keypress", function (e) {
        if (e.key === "Enter") {
          sendChatMessage();
        }
      });
    });
  </script>
</head>

<style>
  .countdown-screen {
    position: absolute;
    width: inherit;
    height: inherit;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 5rem;
    font-weight: 700;
    color: white;
    background-color: rgba(100, 100, 100, 0.7);
    z-index: 1;
  }
</style>

<body>
  <div class="container">
    <div class="player-screen">
      <div class="player-show">
        <p id="player0-screen">ets709(상대 화면)</p>
      </div>
      <div class="game-main">
        <div class="countdown-screen"></div>
        <div id="player0-typing-text-container" class="typing-text-container"></div>
        <div class="typing-box">
          <input id="player0-typing-input" class="typing-input" type="text" autocomplete="off" disabled />
        </div>
        <div id="typing-log" class="typing-log">
        </div>
      </div>
      <div class="game-sub">
        <div class="game-info">
          <div class="game-info-bottom">
            <p class="game-combo-box">
              <span>Combo</span>
              <span id="player0-combo" class="player-combo">0</span>
            </p>
            <p class="game-bomb-box">
              <span>Bomb</span>
              <span id="player0-bomb" class="player-game-bomb">
                <i class="bi bi-star-fill" style="color: rgb(186, 214, 58);"></i>
                <i class="bi bi-star-fill" style="color: rgb(186, 214, 58);"></i>
              </span>
            </p>
            <p class="game-attack-gauge-box">
              <span>공격 게이지</span>
              <span id="player0-game-attack-gauge" class="player-game-attack-gauge">
                <span id="player0-attack-gauge-bar" class="attack-gauge-bar"></span>
                <span id="player0-attack-gauge-text" class="attack-gauge-text">0</span>
              </span>
            </p>
          </div>
          <div class="game-info-top">
            <div class="game-score-box">
              <span>점수</span>
              <span id="player0-score" class="player-score">0</span>
            </div>
            <p class="game-average-typing-speed-box">
              <span>평균 타자속도</span>
              <span id="player0-average-typing-speed" class="player-average-typing-speed">0타</span>
            </p>
            <p class="game-average-accuracy-box">
              <span>평균 정확도</span>
              <span id="player0-average-accuracy" class="player-average-accuracy">0%</span>
            </p>
            <br>
            <p class="game-current-typing-speed-box">
              <span>현재 타자속도</span>
              <span id="player0-current-typing-speed" class="player-current-typing-speed">0타</span>
            </p>
            <p class="game-current-accuracy-box">
              <span>현재 정확도</span>
              <span id="player0-current-accuracy" class="player-current-accuracy">0%</span>
            </p>
          </div>
        </div>
        <div class="game-remain-time-box">
          <p>남은 시간</p>
          <div class="game-remain-time">
            <p class="game-remain-time-text">00:00</p>
          </div>
        </div>
      </div>
    </div>
    <div class="player-screen">
      <div class="player-show">
        <p id="player1-screen">플레이어1(내 화면)</p>
      </div>
      <div class="game-main">
        <div class="countdown-screen"></div>
        <div id="player1-typing-text-container" class="typing-text-container"></div>
        <div class="typing-box">
          <input id="player1-typing-input" class="typing-input" type="text" autocomplete="off" disabled />
        </div>
        <div id="typing-log" class="typing-log">
          <p class="typing-log-text">d</p>
        </div>
      </div>
      <div class="game-sub">
        <div class="game-info">
          <div class="game-info-bottom">
            <p class="game-combo-box">
              <span>Combo</span>
              <span id="player1-combo" class="player-combo">0</span>
            </p>
            <p class="game-bomb-box">
              <span>Bomb</span>
              <span id="player1-bomb" class="player-game-bomb">
                <i class="bi bi-star-fill" style="color: rgb(186, 214, 58);"></i>
                <i class="bi bi-star-fill" style="color: rgb(186, 214, 58);"></i>
              </span>
            </p>
            <p class="game-attack-gauge-box">
              <span>공격 게이지</span>
              <span id="player1-game-attack-gauge" class="player-game-attack-gauge">
                <span id="player1-attack-gauge-bar" class="attack-gauge-bar"></span>
                <span id="player1-attack-gauge-text" class="attack-gauge-text">0</span>
              </span>
            </p>
          </div>
          <div class="game-info-top">
            <div class="game-score-box">
              <span>점수</span>
              <span id="player1-score" class="player-score">0</span>
            </div>
            <p class="game-average-typing-speed-box">
              <span>평균 타자속도</span>
              <span id="player1-average-typing-speed" class="player-average-typing-speed">0타</span>
            </p>
            <p class="game-average-accuracy-box">
              <span>평균 정확도</span>
              <span id="player1-average-accuracy" class="player-average-accuracy">0%</span>
            </p>
            <br>
            <p class="game-current-typing-speed-box">
              <span>현재 타자속도</span>
              <span id="player1-current-typing-speed" class="player-current-typing-speed">0타</span>
            </p>
            <p class="game-current-accuracy-box">
              <span>현재 정확도</span>
              <span id="player1-current-accuracy" class="player-current-accuracy">0%</span>
            </p>
          </div>
        </div>
        <div class="game-remain-time-box">
          <p>남은 시간</p>
          <div class="game-remain-time">
            <p class="game-remain-time-text">00:00</p>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-screen">
      <div class="chat-box">
        <div id="chat-box-body" class="chat-box-body"></div>
        <input id="chat-input" class="form-control" type="text" placeholder="메시지 입력" autocomplete="off" />
      </div>
      <div class="spectators">
        <div class="spectators-container">
          <p style="font-weight: 500;" class="ms-2">관전자</p>
          <div id="spectator-list" class="spectator-list">
            <p class="spectator">관전자1</p>
            <p class="spectator">관전자2</p>
            <p class="spectator">관전자3</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="loading-container">
    <div class="loading-box">
      <div class="progress loading-box" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div id="progress-percentage" class="progress-text">0%</div>
        <div id="progress-bar-value" class="progress-bar progress-bar-striped progress-bar-animated bg-info"
          style="width: 0%"></div>
      </div>
    </div>
    <p id="loading-text">연결중...</p>
  </div>
</body>

</html>